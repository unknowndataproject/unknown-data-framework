services:
  crawler:
    build: ./crawler/
    user: "${UID}:${GID}"
    volumes:
      - ./data/crawler:/data/crawler
      - ./data/mentions:/data/mentions
      - ./data/coreference:/data/coreference
      - ./data/dblp-export:/data/dblp-export
      - ./data/gesis-export:/data/gesis-export

  mentions-web:
    build: ./mentions-web/
    user: "${UID}:${GID}"
    environment:
      - NVIDIA_VISIBLE_DEVICES=7  # GPU ID you want to use
    volumes:
      - ./data/crawler:/data/crawler
      - ./data/mentions:/data/mentions
      - ./data/coreference:/data/coreference
      - ./data/dblp-export:/data/dblp-export
      - ./data/gesis-export:/data/gesis-export
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
            - capabilities: [gpu]
    depends_on:
      crawler:
        condition: service_completed_successfully

  grobid-service:
    image: grobid/grobid:0.8.0
    user: "${UID}:${GID}"
    environment:
      - NVIDIA_VISIBLE_DEVICES=5  # GPU ID you want to use
    restart: "unless-stopped"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://grobid-service:8070/api/isalive"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]

  mentions-pdf:
    build: ./mentions-pdf/
    user: "${UID}:${GID}"
    environment:
      - NVIDIA_VISIBLE_DEVICES=6  # GPU ID you want to use
    volumes:
      - ./data/crawler:/data/crawler
      - ./data/mentions:/data/mentions
      - ./data/coreference:/data/coreference
      - ./data/dblp-export:/data/dblp-export
      - ./data/gesis-export:/data/gesis-export
    depends_on:
      grobid-service:
        condition: service_healthy

  coreference:
    build: ./coreference/
    user: "${UID}:${GID}"
    volumes:
      - ./data/crawler:/data/crawler
      - ./data/mentions:/data/mentions
      - ./data/coreference:/data/coreference
      - ./data/dblp-export:/data/dblp-export
      - ./data/gesis-export:/data/gesis-export
    depends_on:
      mentions-web:
        condition: service_completed_successfully
      mentions-pdf:
        condition: service_completed_successfully

  dblp-export:
    build: ./dblp-export/
    user: "${UID}:${GID}"
    volumes:
      - ./data/crawler:/data/crawler
      - ./data/mentions:/data/mentions
      - ./data/coreference:/data/coreference
      - ./data/dblp-export:/data/dblp-export
      - ./data/gesis-export:/data/gesis-export
    depends_on:
      coreference:
        condition: service_completed_successfully

  gesis-export:
    build: ./gesis-export/
    user: "${UID}:${GID}"
    volumes:
      - ./data/crawler:/data/crawler
      - ./data/mentions:/data/mentions
      - ./data/dblp-export:/data/dblp-export
      - ./data/gesis-export:/data/gesis-export
    depends_on:
      coreference:
        condition: service_completed_successfully
